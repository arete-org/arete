# === Build stage ===
FROM node:22-slim AS builder

# Build context root
WORKDIR /app

# --- Tooling ---
RUN corepack enable && corepack prepare pnpm@10.26.2 --activate

# --- System deps ---
RUN apt-get update \
  && apt-get install -y --no-install-recommends python3 make g++ \
  && rm -rf /var/lib/apt/lists/*

# --- Workspace metadata ---
COPY tsconfig.json ./tsconfig.json
COPY package.json pnpm-workspace.yaml ./
COPY packages/discord-bot/package.json packages/discord-bot/package.json
COPY packages/contracts/package.json packages/contracts/tsconfig.json packages/contracts/

# --- Dependencies ---
COPY pnpm-lock.yaml* ./
RUN pnpm install --frozen-lockfile --prod=false

# --- Sources ---
COPY packages/contracts/src/ packages/contracts/src/
COPY packages/discord-bot/ packages/discord-bot/

# --- Build ---
RUN pnpm --filter @arete/contracts run build \
  && pnpm exec tsc -p packages/discord-bot/tsconfig.json \
  && mkdir -p packages/discord-bot/dist/utils/prompts \
  && cp packages/discord-bot/src/utils/prompts/defaults.yaml packages/discord-bot/dist/utils/prompts/defaults.yaml \
  && CI=true pnpm --filter @arete/discord-bot... install --prod

# === Runtime stage ===
FROM node:22-slim

WORKDIR /app
ENV NODE_ENV=production

# Use the non-root `node` user that already exists in the base image.
COPY --from=builder --chown=node:node /app/packages /app/packages
COPY --from=builder --chown=node:node /app/node_modules /app/node_modules

USER node

# --- Runtime ---
WORKDIR /app/packages/discord-bot
CMD ["node", "dist/index.js"]
