# === Build stage ===
FROM node:22-slim AS build

# Build context root
WORKDIR /app

# --- Tooling ---
RUN corepack enable && corepack prepare pnpm@10.26.2 --activate

# --- Workspace metadata ---
COPY tsconfig.json ./tsconfig.json
COPY package.json pnpm-workspace.yaml ./
COPY packages/web/package.json packages/web/package.json
COPY packages/backend/package.json packages/backend/tsconfig.json packages/backend/
COPY packages/contracts/package.json packages/contracts/tsconfig.json packages/contracts/

# --- Dependencies ---
COPY pnpm-lock.yaml* ./
RUN pnpm install --frozen-lockfile

# --- Sources ---
COPY packages/web/ packages/web/
COPY packages/backend/src/ packages/backend/src/
COPY packages/contracts/src/ packages/contracts/src/

# --- Build ---
RUN pnpm --filter @arete/contracts run build \
  && pnpm --filter @arete/web run build

# === Runtime stage ===
FROM caddy:2.10.2-alpine

COPY --from=build /app/packages/web/dist /usr/share/caddy
COPY deploy/Caddyfile /etc/caddy/Caddyfile
