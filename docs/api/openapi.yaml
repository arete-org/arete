# Spec version for this file; change only when upgrading tooling.
openapi: 3.1.0

# Quick Map
# - POST /api/reflect: Reflection (public; Turnstile + rate limits when configured)
# - OPTIONS /api/reflect: CORS preflight
# - POST /api/traces: Trace upsert (TraceToken required)
# - GET /api/traces/{responseId}: Trace fetch (public)
# - GET /api/blog-posts: Blog index (public)
# - GET /api/blog-posts/{postId}: Blog post (public)
# - POST /api/webhook/github: GitHub discussion webhook (signature when configured)
# - GET /config.json: Runtime config (public)

# ====================
# Public API metadata
# ====================
info:
    title: ARETE Backend API
    # Versioning: bump when request/response shapes, status codes, or auth requirements change; docs-only edits can skip.
    version: 1.0.0
    license:
        name: MIT + Hippocratic License v3 (HL3-CORE)
        url: docs/LICENSE_STRATEGY.md
    description: |
        Backend wire contract and integration boundary for other packages.
        Reflection is the trimmed-down, web-facing slice of the AI chat system for embeddable UIs.
        Non-2xx responses use ErrorResponse unless an operation states otherwise.
        info.version is manually maintained (see docs/api/README.md).

# Explicitly mark endpoints as unauthenticated by default.
security: []

# ====================
# Base URLs
# ====================
servers:
    - url: https://{backendHost}
      description: Backend API base URL
      variables:
          backendHost:
              default: api.your-domain.tld

# ====================
# Tags
# ====================
tags:
    - name: Chat
      description: Chat responses.
    - name: Image # [Reserved]
      description: Image generation.
    - name: Voice # [Reserved]
      description: Voice and audio.
    - name: Traces
      description: Trace storage and retrieval.
    - name: Blog
      description: Public blog content.
    - name: Webhooks
      description: Webhook ingestion.
    - name: System
      description: Runtime config and service metadata.

# ====================
# Endpoints
# ====================
paths:
    # Reflection (public, Turnstile when enabled, rate-limited).
    /api/reflect:
        post:
            operationId: postReflect
            summary: Generate a reflective response
            description: |
                Generate a reflective response from a question in the JSON body.
                Turnstile required when enabled; rate limited per IP/session; send X-Session-Id / X-Turnstile-Token headers.
            tags:
                - Chat
            parameters:
                - $ref: '#/components/parameters/SessionIdHeader'
                - $ref: '#/components/parameters/TurnstileTokenHeader'
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/ReflectRequest'
            responses:
                '200':
                    $ref: '#/components/responses/ReflectOk'
                '403':
                    $ref: '#/components/responses/Forbidden'
                '400':
                    $ref: '#/components/responses/BadRequest'
                '405':
                    $ref: '#/components/responses/MethodNotAllowed'
                '413':
                    $ref: '#/components/responses/PayloadTooLarge'
                '429':
                    $ref: '#/components/responses/TooManyRequests'
                '500':
                    $ref: '#/components/responses/InternalServerError'
                '502':
                    $ref: '#/components/responses/BadGateway'
                '503':
                    $ref: '#/components/responses/ServiceUnavailable'
        options:
            operationId: optionsReflect
            summary: CORS preflight
            description: |
                Handle CORS preflight for the reflect endpoint.
                Public endpoint; no auth or rate limits.
            tags:
                - Chat
            responses:
                '204':
                    $ref: '#/components/responses/PreflightAccepted'

    # Trace upsert (TraceToken required, rate-limited).
    /api/traces:
        post:
            operationId: postTraces
            summary: Upsert trace metadata
            description: |
                Store ResponseMetadata for a responseId.
                TraceToken required; rate limited per client IP.
            tags:
                - Traces
            security:
                - TraceToken: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/TraceUpsertRequest'
            responses:
                '200':
                    $ref: '#/components/responses/TraceUpsertOk'
                '401':
                    $ref: '#/components/responses/Unauthorized'
                '403':
                    $ref: '#/components/responses/Forbidden'
                '400':
                    $ref: '#/components/responses/BadRequest'
                '405':
                    $ref: '#/components/responses/MethodNotAllowed'
                '413':
                    $ref: '#/components/responses/PayloadTooLarge'
                '429':
                    $ref: '#/components/responses/TooManyRequests'
                '500':
                    $ref: '#/components/responses/InternalServerError'
                '503':
                    $ref: '#/components/responses/ServiceUnavailable'

    # Trace fetch (public).
    /api/traces/{responseId}:
        get:
            operationId: getTrace
            summary: Fetch a stored trace
            description: |
                Return stored ResponseMetadata by response ID.
                Public endpoint; no auth or rate limits.
            tags:
                - Traces
            parameters:
                - $ref: '#/components/parameters/TraceResponseId'
            responses:
                '200':
                    $ref: '#/components/responses/TraceFetchOk'
                '400':
                    $ref: '#/components/responses/BadRequest'
                '404':
                    $ref: '#/components/responses/NotFound'
                '410':
                    $ref: '#/components/responses/Gone'
                '500':
                    $ref: '#/components/responses/InternalServerError'
                '503':
                    $ref: '#/components/responses/ServiceUnavailable'

    # Blog index (public).
    /api/blog-posts:
        get:
            operationId: listBlogPosts
            summary: List blog posts
            description: |
                Return the public blog index (trailing slash accepted).
                Public endpoint; no auth or rate limits.
            tags:
                - Blog
            responses:
                '200':
                    $ref: '#/components/responses/BlogIndexOk'
                '405':
                    $ref: '#/components/responses/MethodNotAllowed'
                '500':
                    $ref: '#/components/responses/InternalServerError'

    /api/blog-posts/{postId}:
        get:
            operationId: getBlogPost
            summary: Fetch a blog post
            description: |
                Return a single blog post by numeric id.
                Public endpoint; no auth or rate limits.
            tags:
                - Blog
            parameters:
                - $ref: '#/components/parameters/BlogPostId'
            responses:
                '200':
                    $ref: '#/components/responses/BlogPostOk'
                '400':
                    $ref: '#/components/responses/BadRequest'
                '404':
                    $ref: '#/components/responses/NotFound'
                '405':
                    $ref: '#/components/responses/MethodNotAllowed'
                '500':
                    $ref: '#/components/responses/InternalServerError'

    # GitHub webhook (signature when configured).
    /api/webhook/github:
        post:
            operationId: postGitHubWebhook
            summary: Ingest GitHub discussion webhook
            description: |
                Accept GitHub discussion events to sync blog posts.
                Signature required when configured; otherwise ignored.
            tags:
                - Webhooks
            security:
                # Signature is enforced only when GITHUB_WEBHOOK_SECRET is configured; otherwise requests are ignored with 200.
                - GitHubWebhookSignature: []
            requestBody:
                required: true
                content:
                    application/json:
                        schema:
                            $ref: '#/components/schemas/GitHubDiscussionWebhook'
            responses:
                '200':
                    $ref: '#/components/responses/WebhookOk'
                '401':
                    $ref: '#/components/responses/Unauthorized'
                '400':
                    $ref: '#/components/responses/BadRequest'
                '405':
                    $ref: '#/components/responses/MethodNotAllowed'
                '413':
                    $ref: '#/components/responses/PayloadTooLarge'
                '500':
                    $ref: '#/components/responses/InternalServerError'

    # Runtime config (public).
    /config.json:
        get:
            operationId: getRuntimeConfig
            summary: Fetch runtime config
            description: |
                Return public runtime configuration for web clients.
                Public endpoint; no auth or rate limits.
            tags:
                - System
            responses:
                '200':
                    $ref: '#/components/responses/RuntimeConfigOk'
                '405':
                    $ref: '#/components/responses/MethodNotAllowed'
                '500':
                    $ref: '#/components/responses/InternalServerError'

# ====================
# Components
# ====================
components:
    # Auth schemes and signature checks for trusted callers.
    securitySchemes:
        # Shared secret for trace ingestion.
        TraceToken:
            type: apiKey
            in: header
            name: x-arete-trace-token
            description: Shared secret for trusted trace ingestion.
        # GitHub webhook signature verification.
        GitHubWebhookSignature:
            type: apiKey
            in: header
            name: X-Hub-Signature-256
            description: GitHub webhook signature (sha256=...).

    # Data models for request/response payloads.
    schemas:
        # Errors.
        # Standard error envelope.
        ErrorResponse:
            type: object
            properties:
                error:
                    type: string
                details:
                    type: string
                retryAfter:
                    type: integer
                    description: Seconds until retry is allowed.
            required:
                - error
            additionalProperties: false

        # Reflection.
        # Reflect payloads.
        ReflectRequest:
            type: object
            properties:
                question:
                    type: string
                    maxLength: 3072
            required:
                - question
            additionalProperties: true

        ReflectResponse:
            type: object
            properties:
                message:
                    type: string
                metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
            required:
                - message
                - metadata
            additionalProperties: false

        # Traces + provenance.
        # Trace metadata payloads.
        ResponseMetadataBase:
            type: object
            properties:
                provenance:
                    type: string
                    description: Expected values are Retrieved, Inferred, or Speculative.
                confidence:
                    type: number
                    description: Expected range is 0.0 to 1.0.
                riskTier:
                    type: string
                    description: Expected values are Low, Medium, or High.
                tradeoffCount:
                    type: number
                    description: Expected minimum is 0.
                chainHash:
                    type: string
                licenseContext:
                    type: string
                modelVersion:
                    type: string
                staleAfter:
                    type: string
                    format: date-time
                citations:
                    type: array
                    items:
                        $ref: '#/components/schemas/Citation'
                imageDescriptions:
                    type: array
                    items:
                        type: string
            required:
                - provenance
                - confidence
                - riskTier
                - tradeoffCount
                - chainHash
                - licenseContext
                - modelVersion
                - staleAfter
                - citations
            additionalProperties: true

        ResponseMetadata:
            allOf:
                - $ref: '#/components/schemas/ResponseMetadataBase'
                - type: object
                  properties:
                      responseId:
                          type: string
                  required:
                      - responseId

        TraceUpsertRequest:
            description: ResponseMetadata payload for trace ingestion.
            allOf:
                - $ref: '#/components/schemas/ResponseMetadata'

        # Citations for provenance and attribution.
        Citation:
            type: object
            properties:
                title:
                    type: string
                url:
                    type: string
                    format: uri
                snippet:
                    type: string
            required:
                - title
                - url
            additionalProperties: false

        # Trace ingest and expiry responses.
        TraceUpsertResponse:
            type: object
            properties:
                ok:
                    type: boolean
                responseId:
                    type: string
            required:
                - ok
                - responseId
            additionalProperties: false

        TraceStaleResponse:
            type: object
            properties:
                message:
                    type: string
                metadata:
                    $ref: '#/components/schemas/ResponseMetadata'
            required:
                - message
                - metadata
            additionalProperties: false

        # Blog content.
        # Blog content payloads.
        BlogPostAuthor:
            type: object
            properties:
                login:
                    type: string
                avatarUrl:
                    type: string
                    format: uri
                profileUrl:
                    type: string
                    format: uri
            required:
                - login
                - avatarUrl
                - profileUrl
            additionalProperties: false

        BlogPostIndexEntry:
            type: object
            properties:
                number:
                    type: integer
                title:
                    type: string
                author:
                    $ref: '#/components/schemas/BlogPostAuthor'
                createdAt:
                    type: string
                    format: date-time
                updatedAt:
                    type: string
                    format: date-time
            required:
                - number
                - title
                - author
                - createdAt
                - updatedAt
            additionalProperties: false

        BlogPost:
            type: object
            properties:
                number:
                    type: integer
                title:
                    type: string
                author:
                    $ref: '#/components/schemas/BlogPostAuthor'
                createdAt:
                    type: string
                    format: date-time
                updatedAt:
                    type: string
                    format: date-time
                body:
                    type: string
                discussionUrl:
                    type: string
                    format: uri
                commentCount:
                    type: integer
            required:
                - number
                - title
                - author
                - createdAt
                - updatedAt
                - body
                - discussionUrl
                - commentCount
            additionalProperties: false

        # Runtime config.
        # Public runtime config payload.
        RuntimeConfig:
            type: object
            properties:
                turnstileSiteKey:
                    type: string
                    description: Empty string when Turnstile is disabled.
            required:
                - turnstileSiteKey
            additionalProperties: false

        # Webhooks.
        # Webhook response envelopes.
        WebhookSuccessResponse:
            type: object
            properties:
                success:
                    type: boolean
                    const: true
                postNumber:
                    type: integer
            required:
                - success
                - postNumber
            additionalProperties: false

        WebhookIgnoredResponse:
            type: object
            properties:
                message:
                    type: string
            required:
                - message
            additionalProperties: false

        # GitHub discussion webhook payload (subset).
        GitHubDiscussionWebhook:
            type: object
            description: |
                TODO: confirm full GitHub discussion webhook payload; this is the required subset.
            properties:
                action:
                    type: string
                repository:
                    type: object
                    properties:
                        full_name:
                            type: string
                    required:
                        - full_name
                    additionalProperties: true
                discussion:
                    type: object
                    properties:
                        number:
                            type: integer
                        title:
                            type: string
                        body:
                            type: string
                        user:
                            type: object
                            properties:
                                login:
                                    type: string
                                avatar_url:
                                    type: string
                                    format: uri
                                html_url:
                                    type: string
                                    format: uri
                            required:
                                - login
                                - avatar_url
                                - html_url
                            additionalProperties: true
                        created_at:
                            type: string
                            format: date-time
                        updated_at:
                            type: string
                            format: date-time
                        html_url:
                            type: string
                            format: uri
                        comments:
                            type: integer
                        category:
                            type: object
                            properties:
                                name:
                                    type: string
                            additionalProperties: true
                    required:
                        - number
                        - title
                        - body
                        - user
                        - created_at
                        - updated_at
                        - html_url
                    additionalProperties: true
            required:
                - action
                - repository
                - discussion
            additionalProperties: true

    parameters:
        # Shared request parameters.
        # X-Session-Id is sanitized to alphanumeric/dash/underscore and max 128 chars (see reflect handler).
        SessionIdHeader:
            name: X-Session-Id
            in: header
            required: false
            description: Optional client-generated session id used for per-session rate limiting; when omitted, the server falls back to IP.
            schema:
                type: string

        TurnstileTokenHeader:
            name: X-Turnstile-Token
            in: header
            required: false
            description: Turnstile CAPTCHA token header when enabled.
            schema:
                type: string

        TraceResponseId:
            name: responseId
            in: path
            required: true
            description: Response id used to fetch a trace.
            schema:
                type: string

        BlogPostId:
            name: postId
            in: path
            required: true
            description: Numeric blog post id.
            schema:
                type: string
                pattern: '^\d+$'

    # No shared request bodies yet.
    requestBodies: {}

    # ====================
    # Shared responses
    # ====================
    responses:
        # Success responses.
        PreflightAccepted:
            description: Preflight accepted.
        ReflectOk:
            description: Reflect response with metadata.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ReflectResponse'
        TraceUpsertOk:
            description: Trace stored.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/TraceUpsertResponse'
        TraceFetchOk:
            description: Trace metadata.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ResponseMetadata'
        BlogIndexOk:
            description: Blog index entries.
            content:
                application/json:
                    schema:
                        type: array
                        items:
                            $ref: '#/components/schemas/BlogPostIndexEntry'
        BlogPostOk:
            description: Blog post.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/BlogPost'
        WebhookOk:
            description: Webhook processed or ignored.
            content:
                application/json:
                    schema:
                        oneOf:
                            - $ref: '#/components/schemas/WebhookSuccessResponse'
                            - $ref: '#/components/schemas/WebhookIgnoredResponse'
        RuntimeConfigOk:
            description: Runtime config.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/RuntimeConfig'
        # Error envelope: use ErrorResponse (error required; details/retryAfter optional). Add request-id here if introduced.
        BadRequest:
            description: Bad request.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        Unauthorized:
            description: Missing or invalid credentials.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        Forbidden:
            description: Request was refused.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        MethodNotAllowed:
            description: Method not allowed.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        NotFound:
            description: Resource not found.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        TooManyRequests:
            # Rate limit responses include Retry-After header and retryAfter body field (seconds).
            description: Rate limit exceeded.
            headers:
                Retry-After:
                    description: Seconds until retry allowed.
                    schema:
                        type: integer
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        InternalServerError:
            description: Unexpected server error.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        PayloadTooLarge:
            description: Request payload too large.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        ServiceUnavailable:
            description: Service unavailable or not configured.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        BadGateway:
            description: Upstream service error.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/ErrorResponse'
        Gone:
            description: Trace has expired.
            content:
                application/json:
                    schema:
                        $ref: '#/components/schemas/TraceStaleResponse'
